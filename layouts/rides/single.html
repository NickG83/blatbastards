{{ define "main" }}
<div class="container">
  <div class="row">
    <div class="
      col-lg-8 col-lg-offset-2
      col-md-10 col-md-offset-1
      post-container">

      <!-- Big page title -->
      <h1 class="bb-page-title">{{ .Title }}</h1>

      <!-- Key ride facts -->
      <div class="ride-detail-meta">
        <ul>
          {{ with .Params.intro }}
            <li class="ride-intro">{{ . }}</li>
          {{ end }}
          {{ with .Params.region }}
            <li><strong>Region:</strong> {{ . }}</li>
          {{ end }}
          {{ with .Params.distance }}
            <li><strong>Distance:</strong> ~{{ . }} km</li>
          {{ end }}
          {{ with .Params.duration }}
            <li><strong>Duration:</strong> {{ . }}</li>
          {{ end }}
          {{ with .Params.surface }}
            <li><strong>Surface:</strong> {{ . }}</li>
          {{ end }}
          {{ with .Params.meeting_point }}
            <li><strong>Meeting point:</strong> {{ . }}</li>
          {{ end }}
          {{ with .Params.departure_time }}
            <li><strong>Departure time:</strong> {{ . }}</li>
          {{ end }}
        </ul>

        {{ with .Params.route_file }}
          <p class="ride-download-btn">
            <a class="btn btn-sm btn-primary ride-download-btn" href="{{ . }}" download>
              Download route (GPX)
            </a>
          </p>
        {{ end }}
      </div>

      <!-- Optional hero image -->
      {{ with .Params.hero_image }}
        <p>
          <img class="img-responsive" src="{{ . }}" alt="{{ $.Title }}">
        </p>
      {{ end }}

      {{ with .Params.map_embed }}
        <div class="ride-map-embed">
          <h2>Ride map</h2>
          <iframe
            src="{{ . }}"
            width="640"
            height="480"
            style="border:0;"
            loading="lazy"
            allowfullscreen>
          </iframe>
        </div>
      {{ end }}

      <!-- Main ride notes from Decap ("Ride Notes" field) -->
      <div class="ride-detail-content">
        {{ .Content }}
      </div>

      <!-- YouTube video AFTER notes, BEFORE gallery -->
      {{ with .Params.youtube_embed }}
        <div class="ride-video">
          <h2>Ride video</h2>
          <div class="ride-video-wrapper">
            <iframe
              src="{{ . }}"
              width="100%"
              height="360"
              style="border:0;"
              title="{{ $.Title }} ride video"
              loading="lazy"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen>
            </iframe>
          </div>
        </div>
      {{ end }}

{{ with .Params.gallery }}
  <div class="ride-detail-gallery">
    {{ range . }}
      {{ $t := printf "%T" . }}
      {{ if eq $t "string" }}
        <!-- Old format: just a string path -->
        <figure class="ride-gallery-item">
          <img class="ride-gallery-img" src="{{ . | relURL }}" alt="{{ $.Title }}">
        </figure>
      {{ else }}
        <!-- New format: object with image + caption -->
        <figure class="ride-gallery-item">
          <img class="ride-gallery-img" src="{{ .image | relURL }}" alt="{{ .caption | default $.Title }}">
          {{ with .caption }}
            <figcaption class="ride-gallery-caption">{{ . }}</figcaption>
          {{ end }}
        </figure>
      {{ end }}
    {{ end }}
  </div>
{{ end }}

    </div>
  </div>
</div>
{{ end }}